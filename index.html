<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🥝 ARSLAN PRO V10.4 KIWI Edition</title>

  <!-- Fuentes y estilos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <!-- Manifest / PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="logo.png" />

  <!-- Librerías externas -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- Registrar Service Worker -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('./sw.js');
        console.log('Service Worker registrado:', reg.scope);
      } catch (err) {
        console.warn('Error registrando SW:', err);
      }
    });
  }
  </script>

  <style>
    body {font-family:Poppins, sans-serif; background:#fff; color:#111; margin:0;}
    header {background:#16a34a; color:#fff; padding:8px 12px; font-weight:600;}
    nav {display:flex; flex-wrap:wrap; border-bottom:1px solid #e5e7eb;}
    nav button.tab {flex:1; padding:10px; border:none; background:#f9fafb; cursor:pointer;}
    nav button.tab.active {background:#16a34a; color:#fff;}
    section.panel {display:none; padding:10px;}
    section.panel.active {display:block;}
    table {width:100%; border-collapse:collapse;}
    th,td {border:1px solid #e5e7eb; padding:4px 6px; text-align:left;}
    .state-badge {padding:2px 6px; border-radius:6px; color:#fff;}
    .state-green{background:#16a34a;} .state-amber{background:#facc15;color:#000;}
    .state-red{background:#ef4444;}
    .muted{color:#6b7280;font-size:0.9em;}
    .ghost{background:none;border:1px solid #ccc;padding:2px 6px;margin-left:2px;cursor:pointer;}
    button{font-family:inherit;cursor:pointer;}
  </style>
</head>

<body>
<header>🥝 ARSLAN PRO V10.4 — KIWI Edition</header>

<nav>
  <button class="tab active" data-tab="factura">Factura</button>
  <button class="tab" data-tab="clientes">Clientes</button>
  <button class="tab" data-tab="productos">Productos</button>
  <button class="tab" data-tab="facturas">Facturas</button>
  <button class="tab" data-tab="pendientes">Pendientes</button>
  <button class="tab" data-tab="ventas">Ventas</button>
  <button class="tab" data-tab="resumen">Resumen</button>
</nav>

<!-- ========== PANEL FACTURA ========== -->
<section class="panel active" data-tab-panel="factura">
  <h3>Factura</h3>
  <div id="formFactura">
    <label>Cliente:</label>
    <select id="selCliente"></select>
    <button id="btnNuevoCliente">➕ Nuevo cliente</button>

    <div>
      <input id="cliNombre" placeholder="Nombre cliente">
      <input id="cliNif" placeholder="NIF/CIF">
      <input id="cliDir" placeholder="Dirección">
      <input id="cliTel" placeholder="Teléfono">
      <input id="cliEmail" placeholder="Email">
    </div>

    <h4>Productos</h4>
    <table>
      <thead>
        <tr><th>Producto</th><th>Modo</th><th>Cant.</th><th>Bruto</th><th>Tara</th><th>Neto</th><th>Precio</th><th>Origen</th><th>Importe</th><th></th></tr>
      </thead>
      <tbody id="lineasBody"></tbody>
    </table>
    <datalist id="productNamesList"></datalist>

    <button id="btnAddLinea">➕ Línea</button>
    <button id="btnVaciarLineas">🗑 Vaciar</button>

    <div>
      <label><input type="checkbox" id="chkTransporte"> Añadir 10 % Transporte</label>
      <label><input type="checkbox" id="chkIvaIncluido" checked> IVA incluido en precios</label>
    </div>

    <div>
      <p>Subtotal: <span id="subtotal">0 €</span></p>
      <p>Transporte: <span id="transp">0 €</span></p>
      <p>IVA (4 %): <span id="iva">0 €</span></p>
      <p><strong>Total: <span id="total">0 €</span></strong></p>
      <p>Pendiente: <span id="pendiente">0 €</span></p>
    </div>

    <div>
      <label>Pagado:</label>
      <input id="pagado" type="number" step="0.01" placeholder="Importe pagado">
      <select id="estado">
        <option value="pendiente">Pendiente</option>
        <option value="parcial">Parcial</option>
        <option value="pagado">Pagado</option>
      </select>
      <select id="metodoPago">
        <option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option>
      </select>
      <textarea id="observaciones" placeholder="Observaciones"></textarea>
    </div>

    <h4>Pagos parciales</h4>
    <div id="listaPagos"></div>
    <input id="inpPagoParcial" type="number" step="0.01" placeholder="Importe">
    <button id="btnAddPago">➕ Añadir pago</button>

    <hr>
    <button id="btnSumarIVA">➕ Añadir 4 % IVA al total</button>
    <button id="btnGuardar">💾 Guardar</button>
    <button id="btnNueva">🆕 Nueva factura</button>
    <button id="btnImprimir">🖨 PDF</button>
  </div>

  <div id="printArea" style="margin-top:20px;">
    <h3>Factura PDF</h3>
    <canvas id="p-qr" width="100" height="100"></canvas>
    <div id="p-num"></div>
    <div id="p-fecha"></div>
    <div id="p-prov"></div>
    <div id="p-cli"></div>
    <table id="p-tabla"><thead><tr><th>Producto</th><th>Modo</th><th>Cant.</th><th>Bruto</th><th>Tara</th><th>Neto</th><th>Precio</th><th>Origen</th><th>Importe</th></tr></thead><tbody></tbody></table>
    <div>
      <p>Subtotal <span id="p-sub"></span></p>
      <p>Transporte <span id="p-tra"></span></p>
      <p>IVA <span id="p-iva"></span></p>
      <p><strong>Total <span id="p-tot"></span></strong></p>
      <p>Estado <span id="p-estado"></span></p>
      <p>Método <span id="p-metodo"></span></p>
      <p>Obs. <span id="p-obs"></span></p>
      <small id="pdf-foot-note"></small>
    </div>
  </div>
</section>

<!-- ========== PANEL CLIENTES ========== -->
<section class="panel" data-tab-panel="clientes">
  <h3>Clientes</h3>
  <input id="buscarCliente" placeholder="Buscar cliente...">
  <button id="btnAddCliente">➕ Añadir</button>
  <div id="listaClientes"></div>
  <button id="btnExportClientes">⬇️ Exportar</button>
  <button id="btnImportClientes">⬆️ Importar</button>
</section>

<!-- ========== PANEL PRODUCTOS ========== -->
<section class="panel" data-tab-panel="productos">
  <h3>Productos</h3>
  <input id="buscarProducto" placeholder="Buscar producto...">
  <div id="listaProductos"></div>
  <button id="btnExportProductos">⬇️ Exportar</button>
  <button id="btnImportProductos">⬆️ Importar</button>
</section>

<!-- ========== PANEL FACTURAS ========== -->
<section class="panel" data-tab-panel="facturas">
  <h3>Facturas guardadas</h3>
  <select id="filtroEstado">
    <option value="todas">Todas</option><option value="pendiente">Pendiente</option>
    <option value="parcial">Parcial</option><option value="pagado">Pagadas</option>
  </select>
  <input id="buscaCliente" placeholder="Buscar cliente...">
  <div id="listaFacturas"></div>
  <button id="btnExportFacturas">⬇️ Exportar</button>
  <button id="btnImportFacturas">⬆️ Importar</button>
</section>

<!-- ========== PANEL PENDIENTES ========== -->
<section class="panel" data-tab-panel="pendientes">
  <h3>Facturas pendientes</h3>
  <table id="tblPendientes"><thead><tr><th>Cliente</th><th>Nº</th><th>Total pendiente</th><th>Última fecha</th><th></th></tr></thead><tbody></tbody></table>
  <h4>Total global: <span id="resGlobal">0 €</span></h4>
</section>

<!-- ========== PANEL VENTAS ========== -->
<section class="panel" data-tab-panel="ventas">
  <h3>Ventas por cliente</h3>
  <table id="tblVentasCliente"><thead><tr><th>Cliente</th><th>Hoy</th><th>Semana</th><th>Mes</th><th>Total</th></tr></thead><tbody></tbody></table>
  <canvas id="chartDiario" height="200"></canvas>
  <canvas id="chartMensual" height="200"></canvas>
  <canvas id="chartTop" height="200"></canvas>
  <button id="btnExportVentas">⬇️ Exportar CSV</button>
</section>

<!-- ========== PANEL RESUMEN ========== -->
<section class="panel" data-tab-panel="resumen">
  <h3>Resumen</h3>
  <p>Hoy: <span id="vHoy">0 €</span></p>
  <p>Semana: <span id="vSemana">0 €</span></p>
  <p>Mes: <span id="vMes">0 €</span></p>
  <p>Total: <span id="vTotal">0 €</span></p>
  <hr>
  <button id="btnBackup">💾 Backup JSON</button>
  <button id="btnRestore">📂 Restaurar</button>
</section>

<!-- ========== SCRIPTS PRINCIPALES ========== -->
<script src="app.js"></script>
</body>
</html>
